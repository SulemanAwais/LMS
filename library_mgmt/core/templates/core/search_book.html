{% extends 'base_after_login.html' %}
{% load static %}
{% block extra_head %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/styles.css' %}">
{% endblock %}
{% block title %}Search - Smart Library System{% endblock %}

{% block content %}

    <!-- Page Title -->
    <div class="mb-5 text-center">
        <h1 class="lemon-milk text-primary-700 text-3xl">ðŸ“š Book Collection</h1>
        <p class="text-gray-600">Browse and borrow from our extensive library</p>
    </div>

    <!-- Search Box -->
    <div class="mb-4 max-w-xl mx-auto">
        <div class="relative">
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
            <input type="text" id="global-search" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 shadow-sm" placeholder="Search for books by title, author, or ISBN..." />
        </div>
    </div>

    <!-- Book Table -->
    <div id="main-content" class="bg-white rounded-lg shadow-md p-4 mb-8 overflow-hidden">
        <div class="overflow-x-auto">
            <table id="book-table" class="table table-striped" width="100%">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Author</th>
                        <th>ISBN</th>
                        <th>Edition</th>
                        <th>Publisher</th>
                        <th>Available Copies</th>
                        <th>Genre</th>
                        <th>Actions</th>
                        <th>Borrow</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Hidden element to store the staff status -->
    <div id="user-status" data-is-staff="{{ request.user.is_staff }}" class="hidden"></div>

    <!-- Lordicon script -->
    <script src="https://cdn.lordicon.com/lordicon.js"></script>

    <!-- JS: jQuery + DataTables -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

    <!-- IMPORTANT: Only include DataTables CSS, not Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <!-- DataTable Initialization -->
    <script type="text/javascript">
        $(document).ready(function() {
            console.log("Initializing DataTable...");
            var isStaff = $("#user-status").data("is-staff");
            var table = $('#book-table').DataTable({
                "serverSide": true,
                "ajax": {
                    "url": "{% url 'book-list' %}",
                    "type": "GET",
                    "data": function(d) {
                        d.searchTerm = $('#global-search').val();
                    },
                    "error": function(xhr, status, error) {
                        console.error("AJAX request failed. Status:", status, "Error:", error);
                    }
                },
                "columns": [
                    { "data": "title", "className": "text-center" },
                    { "data": "author", "className": "text-center" },
                    { "data": "isbn", "className": "text-center" },
                    { "data": "edition", "className": "text-center" },
                    { "data": "publisher", "className": "text-center" },
                    { "data": "available_copies", "className": "text-center" },
                    { "data": "genre", "className": "text-center" },
                    {
                        "data": null,
                        "defaultContent": "-",
                        "orderable": false,
                        "className": "text-center",
                        "render": function (data, type, row) {
                            let viewURL = "#";
                            let editURL = "#";
                            let deleteURL = "#";
                            let actions = `<div class="flex items-center justify-center space-x-2">`;
                            actions += `
                            <button class="view-btn" data-bs-toggle="tooltip" title="View Details" onclick="window.location.href='${viewURL.replace('0', row.code)}'">
                                <lord-icon
                                    src="https://cdn.lordicon.com/tyounuzx.json"
                                    trigger="hover"
                                    colors="primary:#0c4a6e"
                                    style="width:22px;height:22px">
                                </lord-icon>
                            </button>`;
                            if (isStaff) {
                                actions += `
                                <button class="staff-action-btn edit-btn" data-bs-toggle="tooltip" title="Edit Book" onclick="window.location.href='${editURL.replace('0', row.code)}'">
                                    <lord-icon
                                        src="https://cdn.lordicon.com/wloilxuq.json"
                                        trigger="hover"
                                        colors="primary:#3b82f6"
                                        style="width:22px;height:22px">
                                    </lord-icon>
                                </button>`;
                                actions += `
                                <button class="staff-action-btn delete-btn" data-bs-toggle="tooltip" title="Delete Book" data-bs-toggle="modal" data-bs-target="#deleteOrder" data-url="${deleteURL.replace('0', row.code)}">
                                    <lord-icon
                                        src="https://cdn.lordicon.com/gsqxdxog.json"
                                        trigger="hover"
                                        colors="primary:#ef4444"
                                        style="width:22px;height:22px">
                                    </lord-icon>
                                </button>`;
                            }
                            actions += `</div>`;
                            return actions;
                        }
                    },
                    {
                        "data": null,
                        "defaultContent": "-",
                        "orderable": false,
                        "className": "text-center",
                        "render": function (data, type, row) {
                            if (row.available_copies > 0) {
                                return `<button class="borrow-btn" onclick="borrowBook(${row.code})">Borrow</button>`;
                            } else {
                                return `<button class="borrow-btn borrow-btn-taken" disabled>Taken</button>`;
                            }
                        }
                    }
                ],
                columnDefs: [
                    {
                      targets: [0,1,2,3,4], // Index of the column to apply the class
                      createdCell: function(td, cellData, rowData, row, col) {
                        $(td).addClass('ellipsis-cell');
                      }
                    }
                  ],
                "autoWidth": false,
                "searching": false,
                "language": {
                    "search": "Search Books:",
                    "emptyTable": "No books found matching your search criteria",
                    "zeroRecords": "No books found matching your search criteria",
                    "info": "Showing _START_ to _END_ of _TOTAL_ books",
                    "infoEmpty": "Showing 0 to 0 of 0 books",
                    "infoFiltered": "(filtered from _MAX_ total books)",
                    "lengthMenu": "Show _MENU_ books per page",
                    "paginate": {
                        "first": "First",
                        "last": "Last",
                        "next": "Next",
                        "previous": "Prev"
                    }
                },
                "responsive": true,
                "pageLength": 10,
                "lengthMenu": [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]]
            });
            $('#global-search').on('keyup', function() {
                console.log("Searching for:", this.value);
                table.ajax.reload();  // Reload the table with the search term
            });
            $(window).resize(function() {
                table.columns.adjust().draw();
            });
            console.log("DataTable initialized.");
        });
        function borrowBook(bookCode) {
            alert("Book borrowing request submitted successfully!");
        }
    </script>
{% endblock %}